# 计算机网络

## 计算机网络和因特网

### 什么是 Internet?

网络中的网络

#### 具体构造的的角度

- **节点**

  - 主机及其上运行的应用程序
  - 路由器、交换机等网络交换设备

- **边**：通信链路（光纤、同轴电缆以及无线电等等）

  - 接入网链路：与主机直接互通的互联网的链路
  - 主干链路：网路交换设备间的链路

- **协议**：规定语法、语义、时序以及动作

  定义了两个或多个通信实体之间交换的报文格式和次序，以及在报文传输、接收或其他事件方面所采取的动作

#### 服务角度

互联是分布式的应用进程以及为分布式应用进程提供通信服务的基础设施

- 使用通信设施进行通信的分布式应用（Web、电子商务、社交网络等等）
- 通信基础设施为 APP 提供通信服务（无连接不可靠服务、面向连接的可靠服务）

#### 网络结构

- **网络边缘**
  - 主机
  - 应用进程（客户端和服务器）
- **网络核心**
  - 互联着的路由器
  - 网络的网络
- **接入网、物理媒体**
  - 有线或者没线通信链路

### 网络边缘

**组成**：端系统（主机）：运行应用进程（Web、email）

- 客户端/服务器模式（服务器是主，客服端是从）

  客户端向服务器请求、接收服务（Web浏览器/服务器）

- 对等模式（p2p）

  端点既是客服端也是服务器（去中心化的分布式服务）

**采用网络设施的面向连接服务**

目标：在端系统之间传输数据

**TCP 服务**

HTTP、FTP、Telnet、SMTP

- 可靠地、按顺序地传送数据（确认和重传）
- 流量控制（发送方不会淹没接收方）
- 拥塞控制（当网络拥塞时候，发送方降级发送速率）

**UDP 服务**

流媒体、远程会议以及DNS等等

- 无连接
- 无可靠数据传输
- 无流量控制
- 无拥塞控制

---

### 网络核心

路由器的网状结构

**网络的核心的关键功能**

- 路由：决定分组采用的源到目标的路径（路由算法）
- 转发：将分组从路由器的输入链路转移到输出链路上

#### 电路交换

为每个呼叫预留一条专有电路，如电话网

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240323102159697.png" alt="image-20240323102159697" style="zoom:67%;" />  

端到端的资源被分配给从源端到目标端的呼叫（通常被传统电话网络采用）

**独享资源**（不同享）：每个呼叫一旦建立起来就能够保证性能，如果呼叫没有数据发送，被分配的资源就会被浪费

**网络资源**（如带宽）被分成片

- **频分多路复用**（有线电视网络、无线广播等）
  - 原理：FDM 将整个传输频带分割成多个独立的子频带，每个子频带分配给一个信号传输使用
  - 特点：各个信号在整个传输过程中占用固定的频带，互不干扰

- **时分多路复用**（电话网络、数字传输系统等）
  - 原理：TDM 将时间分割成一系列的时隙，每个信号在分配给它的时间时隙中传输
  - 特点：所有信号共享相同的频带宽度，但在不同的时间传输
- **波分多路复用**（长途光纤通信、数据中心内部网络等）
  - 原理：WDM类似于频分多路复用，但在光纤通信中，它使用不同的波长（频率）来区分不同的信号
  - 特点：每个信号分配一个独特的波长，可以在同一条光纤上同时传输

**电路交换不适合计算机之间的通信**

- 建立的连接的时间长
- 计算机之间的通信有突发性，如果使用线路交换，则浪费的片较多（独享）

#### 分组交换

##### 概述

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240525123642280.png" alt="image-20240525123642280" style="zoom:67%;" />  

以分组为单位存储-转发方式

- 被传输到下一个链路之前，整个分组必须达到到达路由器/链路层交换机：存储-转发
- 在一个速率为 R bps 的链路上，一个长度为 L bit 的分组的存储转发延时为 L/R s

##### 排队时延和分组丢失

- 如果到达的分组需要传输到某条链路，但发现该链路正忙于传输其他分组，该到达分组必须在输出缓存中等待。因此，除了存储转发时延以外，分组还要承受输出缓存的排队时延
- 如果路由器的缓存用完了，分组将会抛弃，这就是分组丢失

##### 转发表和路由选择协议

- **转发表**：用于记录目的地址（或目的地址的一部分）映射输出链路地址的表
- **路由选择协议**：用于自动地设置这些转发表。例如，一个路由选择协议可以决定从每台路由器到每个目的地的最短路径，并使用这些最短路径结果来配置路由器中的转发表

##### 按照有无网络层的连接

**数据报网络** (类似：问路 )

- 分组的目标地址决定下一跳 
- 在不同的阶段，路由可以改变 
- Internent

**虚电路网络** 

- 每个分组都带标签（虚电路标识 VCID），标签决定下一跳 
- 在呼叫建立时决定路径，在整个呼叫中路径保持不变 
- 路由器维持每个呼叫的状态信息

#### 分组交换 VS 电路交换

- 分组交换允许更多的用户，适用于突发式传输，但是会排队延迟以及会出现丢包现象
- 分组交换按需分配链路使用。链路传输能力将在所有需要在链路上传输分组的用户之间逐分组地被共享

----

### 接入网

**怎样将端系统和边缘路由器连接？**

- 住宅接入网络
- 单位接入网络 （学校、公司）
- 无线接入网络

#### DSL 因特网接入

DSL 数字用户线，住户通常从提供**本地电话**接入的本地电话公司处获得DSL因特网接入

- 高速下行信道，位于50kHz到1MHz频段
- 中速上行信道，位于4kHz到50kHz频段
- 普通的双向电话信道，位于0到4kHz频段

当使用DSL时，用户的本地电话公司也是它的 ISP。每个用户的 DSL调制解调器使用现有的电话线（即双绞铜线）与位于电话公司的本地中心局(CO)中的数字用户线接入复用器(DSLAM)交换数据

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240518201827152.png" alt="image-20240518201827152" style="zoom:80%;" /> 

#### 电缆因特网接入

利用了有线电视公司现有的有线电视基础设施。住宅从提供有线电视的公司获得了电缆因特网接入

**电缆调制解调器**通常是一个外部设备，通过一个以太网端口连接到家庭PC在电缆头端，**电缆调制解调器端接系统(Cable Modem Termination System,CMTS)**与DSL网络的DSLAM具有类似的功能，即将来自许多下行家庭中的电缆调制解调器发送的模拟信号转换回数字形式

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240518215926988.png" alt="image-20240518215926988" style="zoom:67%;" /> 

**注意**：与DSL不同，DSL每个用户一个专用线路到CO，电缆因特网接入的各用户共享到线缆头端的接入网络

#### 光纤到户 FTTH

一种提供更高速率的新兴技术是光纤到户(Fiber To The Home,TTH)。顾名思义FTTH概念简单，从本地中心局直接到家庭提供了一条光纤路径

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240518221050512.png" alt="image-20240518221050512" style="zoom:67%;" /> 

#### 无线接入网络

在无线LAN环境中，无线用户从/到一个接入点发送/接收分组，该接入点与企业网连接（很可能使用了有线以太网），企业网再与有线因特网相连。一个无线LAN用户通常必须位于接入点的几十米范围内

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240518225002925.png" alt="image-20240518225002925" style="zoom:67%;" /> 

----

### 物理媒体

物理媒体分成两种类型：导引型媒体和非导引型媒体

#### 导引型媒体

信号沿着固体媒介被导引：同轴电缆、光纤、双绞线

**双绞线**

两根绝缘铜导线拧合

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240519151535897.png" alt="image-20240519151535897" style="zoom: 33%;" /> 

**同轴电缆** 

两根同轴的铜导线，双向

- 基带电缆： 电缆上一个单个信道 ；Ethernet
- 宽带电缆： 电缆上有多个信道  ； HFC

![image-20240518230104834](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240518230104834.png) 

**光纤和光缆：**

光脉冲，每个脉冲表示一个 bit，在玻璃纤维中传输

- 高速，点到点的高速传输（如10 Gps-100Gbps传输速率 ）
- 低误码率，在两个中继器之间可以有很长的距离，不受电磁噪声的干扰
- 安全

#### 非导引性媒体

开放的空间传输电磁波或者光信号，在电磁或者光信号中承载数字数据

开放空间传输电磁波，携带要传输的数据

- 无需物理“线缆”
- 双向
- 传播环境效应：反射、吸收 、干扰

**无线链路类型**

**地面微波** 

- e.g. up to 45 Mbps channels

**LAN (e.g., WiFi)** 

- 11Mbps, 54 Mbps,540Mbps…

**wide-area**

- 4G 10Mbps 
- 5G 数Gbps

**卫星**

- 每个信道Kbps 到45Mbps (或者多个聚集信道) 
- 270 msec端到端延迟 
- 同步静止卫星和低轨卫星

----

### Internet 结构和 ISP

- **ISP**（因特网服务提供者）：是个向广大用户综合提供提供互联网接入业务，信息业务和增值业务的公司
- **ICP**（内容提供商）：自己部署专用网络，同时和各级 ISP 连接
- **IXP**：多个对等 ISP 互联互通之处，通常不涉及费用结算（对等接入）
- **POP**：高层 ISP 面向客户网络的接入点，涉及费用结算（多宿：一个底层 ISP 接入 多个高层 ISP）

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240526155909917.png" alt="image-20240526155909917" style="zoom:80%;" /> 

----

### 分组延时、丢失和吞吐量 

**为何会出现分组延时和丢失？**

在路由器缓冲区的分组队列

- 延时：分组等待排到队头、被传输
- 丢失：分组到达时，如果没有可用的缓冲区，则该分组被丢掉（分组到达链路的速率超过了链路输出的能力）

**节点总时延(total nodal delay)**：节点处理时延(nodal processing delay)、排队时延(queuing delay)、传输时延(transmission delay)和传播时延(propagation delay)

![image-20240728170426990](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240728170426990.png) 

#### 四种分组延时

1. 节点处理延时：检查 bit 级差错 ；检查分组首部和决定将分组导向何处

2. 排队延时：在输出链路上等待传输的时间 ； 依赖于路由器的拥塞程度

   流量强度 = La / R (越接近 0，平均排队延时越小；反之越接近 1，平均排队延时趋向于无限大，因此，流量工程中的一条金

   科玉律是：设计系统时流量强度不能大于  1)

   <img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240728172617128.png" alt="image-20240728172617128" style="zoom:50%;" />   

   - R 链路带宽(bps)
   - L 分组长度(bits)
   - a 分组到达队列的平均速率

3. 传输延时：将分组发送到链路上的时间： L / R （R：链路带宽(bps) ； L：分组长度(bits)） ；存储转发延时

4. 传播延时：传播延时 d / s （d：物理链路的长度 ； s：在媒体上的传播速度）

#### 分组丢失

- 链路的队列缓冲区容量有限
- 当分组到达一个满的队列时，该分组将会丢失
- 丢失的分组可能会被前一个节点或源端系统重传，或根本不重传

#### 吞吐量

吞吐量，在源端和目标端之间传输的速率（数据量/单位时间)

- 瞬间吞吐量：在一个时间点的速率
- 平均吞吐量：在一个长时间内平均值

瓶颈链路：端到端路径上，限制端到端吞吐的链路（水桶效应）

端到端平均吞吐 = min{R1，R2,…,Rn }

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240728195632530.png" alt="image-20240728195632530" style="zoom:67%;" />   

----

### 协议层次及其服务模型

![20240803163157](https://use-typora.oss-cn-hangzhou.aliyuncs.com/oss-cn-hangzhou20240803163157.png)

#### 概念

**服务**：低层实体向上层实体提供他们之间的通信能力

- 服务用户
- 服务提供者

**服务访问点 SAP**：使用下层提供的服务通过层间的接口（类似于上层调用下层的服务函数）

- socket，TCP 向应用层提供得服务访问点（用于区分上层应用）

**原语**：下层提供给上层服务的形式（类似于服务函数参数）

**服务类型**：面向连接的服务以及无连接

例如：TCP 向它的应用程序提供了面向连接的服务， 这种服务确保应用层报文向目的地传递的正确性和流量控制 ；UDP 协议向它的应用程序提供无连接服务。这是一种不提供不必要服务的服务，没有可靠性，没有流量控制，也没有拥塞控制  

**服务与协议的区别**

- 服务(Service)：低层实体向上层实体提供它们之间的通信的能力，是通过原语来操作的，垂直方向
- 协议(protocol)：对等层实体(peer entity)之间在相互通信的过程中，需要遵循的规则的集合，水平方向

**分层处理和实现复杂系统的好处？**

对付复杂的系统

- 概念化：结构清晰，便于标示网络组件，以及描述其相互关系（分层参考模型）
- 结构化：模块化更易于维护和系统升级 （改变某一层服务的实现不影响系统中的其他层次 ）
    -  对于其他层次而言是透明的 

#### 数据单元（DU）
PDU，协议数据单元：上层传输下来的数据 SDU，拼接上本层的 Header的数据则为本层的 PDU（通俗地讲就是封装上层的数据之后的称呼）

![image-20240731130956005](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240731130956005.png)  

SDU 与 PDU 存在关系：多对一（粘包）、一对一、一对多（拆包）的关系

####  协议栈

##### TCP/IP 协议 
- 应用层：网络应用

    - 为人类用户或者其他应用进程提供网络应用服务
    - FTP、SMTP、HTTP、DNS

- 传输层：主机之间的数据传输

    - 在网络层提供的端到端通信基础上，细分为进程到进程，将不可靠的通信变成可靠地通信

    - TCP、UDP

- 网络层：为数据报从源到目的选择路由

    - 主机主机之间的通信，端到端通信，不可靠

    - IP、路由协议

- 链路层：相邻网络节点间的数据传输

    - 2个相邻2点的通信，点到点通信，可靠或不可靠

    - 点对对协议PPP、802.11(wifi)、Ethernet

- 物理层：在线路上传送 bit

![20240803161139](https://use-typora.oss-cn-hangzhou.aliyuncs.com/oss-cn-hangzhou20240803161139.png) 
##### 各层次的协议数据单元
- 应用层：报文（message）
- 传输层：报文段（segment）TCP段，UDP数据报
- 网络层：分组（packet）（如果无连接方式：数据报 datagram）
- 数据链路层：帧（frame）
- 物理层：位（bit）

##### IOS/OSI 参考模型
- 表示层：允许应用解释传输的数据，e.g.、加密、压缩以及机器相关的表示转换
- 会话层：数据交换的同步，检查点，恢复

![20240803161241](https://use-typora.oss-cn-hangzhou.aliyuncs.com/oss-cn-hangzhou20240803161241.png) 


### 计算机网络和因特网的历史
#### 早期计算机网路（1960年以前）
主要使用的是线路交换网络，但是由于线路建立时间过长、独享方式占用通信资源以及可靠性不高等原因，寻求新型的网络模式，便出现分组交换网络

####  分组交换的发展（1961-1972）
网络控制协议是第一个端系统直接的主机-主机协议（NCP协议：相当于传输层和网络层在一起，支持应用开发）

####  专用网络和网络互联 （1972-1980）
定义了今天的Internet体系结构

#### 网络的激增（1980-1990）
1983: TCP/IP部署
- NCP分化成2个层次，TCP/IP，从而出现 UDP
- 覆盖式IP解决网络互联问题
- 主机设备和网络交换设备分开

####  因特网爆炸 （1990, 2000’s）
- TCP/IP体系结构的包容性，在其上部署应用便捷，出现非常多的应用
- 新一代杀手级应用（即时讯息，P2P 文件共享，社交网络等）更进一步促进互联网的发展
- 安全问题不断出现和修订（互联网的补丁对策）

#### 最新发展（2005 - 现在）
高速无线接入无处不在：移动互联时代 
- 4G部署,5G蓄势待发
- 带宽大，终端性能高，价格便宜，应用不断增多

<br/><br/>

## 应用层

### 网络应用的体系结构

- 客户-服务器模式（C/S：client/server）
- 对等模式(P2P：Peer To Peer)
- 混合体：客户-服务器和对等体系结构

#### C/S 体系结构

**服务器**

-  一直运行
- 固定的 IP 地址和周知的端号（约定）
- 扩展性：服务器场（数据中心进行扩展、  扩展性差）

**客户端**

- 主动与服务器通信
- 与互联网有间歇性的连接
- 可能是动态 IP 地址
- 不直接与其它客户端通信

**注意**：服务器 IP 也不一定是固定的，但是域名必须是固定的。可以通过 ddns 来刷新服务器的动态 ip

#### P2P 体系结构

- （几乎）没有一直运行的服务器
- 任意端系统之间可以进行通信
- 每一个节点既是客户端又是服务器
- 参与的主机间歇性连接且可以改变 IP 地址 
- 难以管理

**例子**：Gnutella、迅雷

#### C/S 和 P2P 体系结构的混合体

**Napster**

- 文件搜索：集中 
- 文件传输：P2P 

**即时通信**

- 在线检测：集中
  - 当用户上线时，向中心服务器注册其IP地址
  - 用户与中心服务器联系，以找到其在线好友的位置
- 两个用户之间聊天：P2P

---

### 进程通信

#### 概述

**进程**（在主机上运行的应用程序）

- 分为客户端进程、服务端进程
- 在同一个主机内，使用进程间通信机制通信
- 不同主机间，通过报文来通信


**进程寻址**

进程为了接收报文，必须有一个**标识**，即：SAP（发送也需要标示）

- 主机：唯一的 32位IP地址 
- 所采用的传输层协议：TCP or UDP
- 端口号（Port Numbers）

**层间接口必须要携带的信息** 

- 要传输的报文（对于本层来说：SDU） 
- 谁传的：对方的应用进程的标示：IP + TCP(UDP) 端口 
- 传给谁：对方的应用进程的标示：对方的 IP + TCP(UDP) 端口号

如果Socket API 每次传输报文，都携带如此多的信息，太繁琐易错，不便于管理

#### 套接字（Socket）

一个进程向另一个进程发送的报文必须通过下面的网络时候，进程通过一个称为套接字的软件接口向网络发送报文和从网络接收报文，因此套接字也称为应用程序和网络之间的应用程序编程接口 API

- 进程向套接字发送报文或从套接字接收报文（套接字 <=> 门户）
- 发送进程将报文推出门户，发送进程依赖于传输层设施在另外一侧的门将报文交付给接受进程 
- 接收进程从另外一端的门户收到报文（依赖于传输层设施）

![image-20240814224408695](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240814224408695.png)

#### TCP socket

- TCP服务，两个进程之间的通信需要之前要建立连接 

-  两个进程通信会持续一段时间，通信关系稳定

-  可以用**一个整数表示两个应用实体之间的通信关系**，本地标示

  四元组：源端系统 ip 、源端系统 port 、目标端系统 ip 、目标端系统 port 

#### UDP socket

- UDP服务，两个进程之间的通信需要之前无需建立连接 

  - 每个报文都是独立传输的 
  - 前后报文可能给不同的分布式进程

- 穿过层间接口的信息大小最小

- 只能用一个整数表示本应用实体的标示 

  二元组：本机 ip、本机 port

注意：但是传输报文时：必须要提供对方ip、port 

----

### 应用层协议

运行在不同端系统上的应用进程如何相互交换报文（协议定义规范）

- 交换的报文类型：请求和应答报文
- 各种报文类型的语法：报文中的各个字段及其描述 
- 字段的语义：即字段取值的含义 
- 进程何时、如何发送报文及对报文进行响应的规则
- 应用协议仅仅是应用的一个组成部分

**公开协议以及专用协议**

- 公开协议：由RFC文档定义允许互操作，如：HTTP、SMTP
- 专用（私有）协议：协议不公开，如：Skype

---

### 应用层需要传输层提供的服务

- 数据丢失率
    - 有些应用则要求100%的可靠数据传输（如文件）
    - 有些应用（如音频）能容忍一定比例以下的数据丢失
- 吞吐
    -  一些应用出于有效性考虑，对数据传输有严格的时间限制 (Internet 电话、交互式游戏 )
- 延迟
    - 一些应用（如多媒体）必须需要最小限度的吞吐，从而使得应用能够有效运转
    - 一些应用能充分利用可供使用的吞吐(弹性应用)
- 安全性（机密、完整性、可认证性）

**常见应用对传输服务的要求**

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240815222317474.png" alt="image-20240815222317474" style="zoom: 80%;" />  

----

### Web 与 HTTP

#### 概念 

Web页由一些对象组成，对象可以是HTML文件、JPEG图像、Java小程序、声音剪辑文件等

- 多数Web页都含有一个 HTML 基本文件，该 HTML 基本文件又包含若干对象的引用（链接）
- 通过URL对每个对象进行引用：访问协议，用户名，口令字，端口等

Web 的应用层协议的核心是**超文本传输协议 HTTP**

- 定义了 Web 客户向 Web 服务器请求 Web 页面的方式，以及服务器向客户传送 Web 页面的方式
- 使用传输层 TCP 协议建立连接
- HTTP 是无状态的，服务器并不维护客户的信息

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817165707660.png" alt=" " style="zoom:67%;" />   

#### 非持续连接和持续连接

**概述**

在许多因特网应用程序中，客户和服务器在 个相当长的时间范围内通信，当这种客户一服务器的交互是经 TCP 进行的，应用程序的研制者就需要做一个重要决定 ，即每个请求/响应对是经个**单独的 TCP 连接**发送，还是所有的请求及其应经**相同 TCP 连接**发送呢?

前者就是非持续连接，后者就是持续连接（HTTP1.0 采用的是非持续连接；HTTP1.1 采用的是持续连接）

**非持续连接存在的问题**

-  必须为每一个请求的对象建立和维护一个全新的连接，对于每个这样的连接，在客户和服务器中都要分配 TCP 的缓冲区和保持 TCP 变量，这给 Web 服务器带来了严重的负担，因为 Web 服务器可能同时服务于数以百计不同的客户的请求 
- 每一个对象经受两倍 RTT 的交付时延，即一个 RTT 用于创建 TCP ，另一个 RTT 用于请求和接收一个对象

**响应时间模型**

- **往返时间 RTT**：一个小的分组从客户端到服务器，再回到客户端的时间
- **响应时间**：发起TCP连接时间 + HTTP请求等待时间 + 传输时间 = 2RTT + 传输时间

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817170743019.png" alt="  " style="zoom:67%;" /> 

#### HTTP报文格式

##### 请求报文

请求报文第一行称为 **请求行**，后继的行称为 **首部行**，最后可能还有**实体对象**（实体对象会和首部行中间会有回车或者换行，注意是在特定的请求方法下才有内容，如 POST）

- 请求行有三个字段：方法字段、URL 字段、HTTP 版本字段

  ![image-20240817171710053](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817171710053.png) 

- 首部行指明了对象的主机域名/IP、是否继续连接、用户代理（比如浏览器版本）、语言类型等等

  ![image-20240817171933273](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817171933273.png) 

- 一个HTTP请求报文的通用格式

  <img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817172400390.png" alt="image-20240817172400390" style="zoom:67%;" />  

##### 响应报文

它也是由三部分组成：一个**初始状态行**，**首部行** , 然后是**实体对象**

- 状态行有 3 个字段：协议版本字段、状态码和相应状态信息

  ![  ](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817172936182.png) 

- 首部行指明了是否继续连接、服务器产生并发送该响应报文的日期和时间、用户代理（比如浏览器版本）、上次对象创建或者最后修改的日期和时间等等

  <img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817220439467.png" alt="image-20240817220439467" style="zoom:67%;" /> 

- 一个HTTP 响应报文的通用格式

  <img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817220728619.png" alt="image-20240817220728619" style="zoom:67%;" /> 

**响应状态码**

- **200 OK** ：请求成功
- **301 Moved Permanently** 
  - 请求的对象已经被永久转移了；新的URL在响应报文的 Location（首部行中指定）
  - 客户端软件自动用新的 URL 去获取对象
- **400 Bad Request** ：一个通用的差错代码，表示该请求不能被服务器理解
- **404 Not Found** ：请求的文档在该服务上没有找到
-  **505 HTTP Version Not Supported**：服务器不支持请求报文使用的 HTTP 协议版本

#### Cookie

用于维护客户和服务器之间的状态（HTTP 是无状态的）

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817221119552.png" alt="image-20240817221119552" style="zoom:67%;" />   

**缺点**

尽管 cookie 常常能简化用户的因特网活动，但是它的使用仍具有争议，因为它们被认为是对用户隐私的一种侵害；如我们刚才所见，结合 cookie 和用户提供的账户信息，Web 站点可以知道许多有关用户的信息，并可能将这些信息卖给第三方

#### Web 缓存

Web 缓存器 (Web cache) 也叫代理服务器，不访问原始服务器，就能满足客户的请求

- 代理服务器既是服务器又是客户端
- 浏览器将所有的 HTTP 请求发给代理服务器 
  - 在缓存中的对象，直接返回对象
  - 如果不在缓存中，代理服务器请求原始服务器，然后再将对象返回给客户端

![image-20240817221336106](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240817221336106.png) 

**如何判断放在代理服务器中的对象是否是陈旧的？**

通过获取请求头的方式获取到 If-Modified-Since 信息（上次对象创建或者最后修改的日期和时间），进而可以判断出代理服务器中的对象在源服务器中是否有被修改过

----

### FTP 与  EMail

#### 文件传输协议 FTP

- 有状态的协议
- 向远程主机上传输文件或从远程主机接收文件
-  ftp服务器端口号为 21

**FTP客户端与FTP服务器上传下载过程**

- FTP客户端与FTP服务器通过端口 21 联系，并使用TCP作为传输协议
- 客户端通过控制连接获得身份确认
- 客户端通过控制连接发送命令浏览远程目录并上传/下载文件
- 收到一个文件传输命令时，服务器打开一个到客户端的数据连接
- 一个文件传输完成后，服务器关闭连接
- 服务器打开第二个TCP数据连接用来传输另一个文件

注意：建立的控制连接和数据连接不在同一个进程端口上

**建立数据连接的模式**

- 主动模式时，服务器的20号端口主动与客户端的随机端口建立传递数据的连接
- 被动模式时，服务器告知客户端，让其与服务器的某一指定端口建立数据连接，但客户端的端口依然是随机的

#### 电子邮件 EMail

电子邮件是一种异步通信媒介，现代电子邮件具有许多强大的特性，包括具有附件、超链接、 HTTP 格式文本和图片的报文

##### 主要组成部分

- **用户代理**  又名 “邮件阅读器”

  - 撰写、编辑和阅读邮件 如Outlook、Foxmail
  - 输出和输入邮件保存在服务器上
- **邮件服务器**

  - 邮箱中管理和维护发送给用户的邮件
  - 输出报文队列保持待发送邮件报文
- **简单邮件传输协议 SMTP**
  - 客户：发送方邮件服务器 
  - 服务器：接收端邮件服务
  

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240822222417842.png" alt="image-20240822222417842" style="zoom:67%;" /> 

##### SMTP

###### 概述

SMTP 是因特网电子邮件的核心，用于从发送方的邮件服务器发送报文到接收方的邮件服务器

- 持久性链接
- 报文必须为7位 ASCII 码
- 使用TCP在客户端和服务器之间传送报文，端口号：25
- 直接传输：从发送方服务器到接收方服务器，传输的3个阶段

  - 握手
  - 传输报文
  - 关闭

###### SMTP 与 HTTP1.1

相同点是两者都使用持续连接的方式

不同点：

- HTTP 协议主要是一个 PULL 的协议，STMP 基本上是一个 PUSH 的协议
- SMTP 要求每个报文采用7位 ASCII 码，而 HTTP 并没有这种限制
- SMTP 可以将一个既包含文本又包含图片的文件放在同一个报文中，但是 HTTP 不行

##### 邮件报文格式

###### 报文格式

**报文的首部行**：每个首部必须含有一个 From 首部行和一个 To 首部行；一个首部也许包含一个 Subject: 首部行以及其他可选的首部行

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240823131820135.png" alt="image-20240823131820135" style="zoom:67%;" />  

###### 多媒体扩展 MIME

一种用于扩展电子邮件消息功能的标准，允许电子邮件不仅限于文本，还可以包含各种格式的内容如图像、音频、视频等

- 它在多媒体内容传输和Web应用中也被广泛应用

- MIME定义了内容类型（如 `text/html`、`image/png`、`audio/mpeg` 等）以及内容编码方式，从而使得浏览器和其他应用程序能够正确处理和显示这些内容

- 报文的格式

  <img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240824105017006.png" alt="image-20240824105017006" style="zoom:80%;" /> 

##### 邮件访问协议

###### 概述

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240823132238282.png" alt="image-20240823132238282" style="zoom:67%;" /> 

-  SMTP: 传送到接收方的邮件服务器
- 邮件访问协议：从服务器访问邮件 
  - POP3：邮局访问协议（Post Office Protocol） ；用户身份确认 (代理 <=> 服务器) 并下载 
  - IMAP：Internet 邮件访问协议（Internet Mail Access Protocol）；在服务器上处理存储的报文 
  - HTTP

###### POP3

一个极为简单的邮件访问协议（本地管理文件夹）

**工作过程**

当用户代理打开了一个到邮件服务器(服务器)端口 110 上的 TCP 连接后， POP3就开始工作了 

1. 用户代理发送(以明文形式)用户名和口令以鉴别用户
2. 用户代理取回报文，同时在这个阶段用户代理还能进行如下操作，对报文做删除标记，取消报文删除标记，以及获取邮件的统计信息
3. 在客户发出了 quit 命令之后，目的是结束该 POP3 会话；这个时候该邮件服务器删除那些被标记为删除的报文

**注意**

- 可以使用下载并删除、下载并保留两种模式
  - 下载并删除模式：如果改变客户机，客户就不能阅读邮件
  - 下载并保留模式：不同客户机上为报文进行拷贝
- 在用户代理与邮件服务器之间的POP3会话期间，该POP3服务器保留了一些状态信息，特别是记录了哪些用户报文被标记为删除了；然而，POP3服务器并不在POP3会话过程中携带状态信息，会话中不包括状态信息大大简化了POP3服务的实现（在会话中是无状态的） 

###### IMAP

一种用于电子邮件客户端与邮件服务器之间通信的协议（远程管理文件夹）

它允许用户在服务器上管理和访问电子邮件，而不仅仅是下载到本地客户端；IMAP特别适合于需要在多个设备上访问相同邮箱的场景，例如在手机、电脑和其他设备上查看邮件

- IMAP 服务器将每个报文与一个文件夹联系起来
- 允许用户用目录来组织报文
- 允许用户读取报文组件
- 在会话过程中保留用户状态： 目录名、报文ID与目录名之间映射

---

### DNS

#### 概述

为其他应用提供服务的应用

- 运行在UDP之上端口号为53的应用服务
- 核心的 Internet 功能，但以应用层协议实现，在网络边缘处理复杂性

**DNS 主要用来做什么？**

**主要目的**

ip 地址（ip 地址标识主机、路由器）不好记忆，不便人类使用，一般倾向于使用一些有意义的字符串来标识 Internet上的设备，例如：百度 https://www.baidu.com/baidu 

然而路由器则喜欢定长的、有着层次结构的 ip 地址，例如：127.0.0.1 

因此为了折中这些不同的方式，需要一种能进行主机名到 ip 地址转换的应用服务

**其它目的** 

- 主机别名到规范名字的转换
- 邮件服务器别名到邮件服务器的正规名字的转换
- **负载均衡**：当客户对映射到某地址集合的名字发出一个 DNS 请求时，即服务器用 ip 地址的整个集合进行响应，但在每个回答中循环这些地址次序

#### 域名结构

- 每个(子)域下面可划分为若干子域，树叶是主机

- 域名：从本域往上，直到树根；中间使用 “.” 间隔不同的级别，例如：www.baidu.com

**域与物理网络无关**

- 域遵从组织界限，而不是物理网络 
  - 一个域的主机可以不在一个网络 
  - 一个网络的主机不一定在一个域
- 域的划分是逻辑的，而不是物理的

#### 工作机理

##### 集中式设计

客户直接将所有查询直接发往单一的 DNS 服务器，同时该 DNS 服务器直接对所有的查询客户做出响应。尽管这种设计的简单性非常具有吸引力，但它不适用于当今的因特网，因为因特网有着数量巨大的主机，存在如下问题

- **单点故障**：如果该 DNS 服务器崩溃，整个因特网随之瘫痪
- **通信容量**：单个 DNS 服务器不得不处理所有的 DNS 查询（上亿台）
- **远距离的集中式数据库**：单个 DNS 服务器不可能"邻近"所有查询客户
- **维护**：单个 DNS 服务器将不得不为所有的因特网主机保留记录

##### 分布式、层次数据库

为了处理扩展性问题， DNS 使用了大量的 DNS 服务器 ，它们以层次方式组织，并且分布在全世界范围内。大致分成3种类型的 DNS 服务器，**根 DNS 服务器**、**顶级域 DNS 服务器**和**权威 DNS 服务器**

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240825141335109.png" alt="image-20240825141335109" style="zoom:67%;" /> 

###### 根 DNS 服务器

根名字服务器由 13个不同的组织管理（根名字服务器提供 TLD 服务器的 ip 地址）

###### 顶级域 DNS 服务器

对于每个顶级域和所有国家的顶级域都有 TLD 服务器(或服务器集群)  (TLD 服务器提供了权威 DNS 服务器的 ip 地址)

- 通用的（.com、.edu、.int 等等）
- 国家的（.cn、.us、.nl等等）

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240824151117670.png" alt="image-20240824151117670" style="zoom:67%;" /> 

###### 权威 DNS 服务器 

组织机构的DNS服务器， 提供组织机构服务器（如Web和mail）可访问的主机和 ip 之间的映射（组织机构可以选择实现自己维护或由某个服务提供商来维护）

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240825142055334.png" alt="image-20240825142055334" style="zoom:67%;" /> 

###### 本地DNS服务器

严格说来，一个本地DNS服务器并不属于该服务器的层次结构，但它对DNS层次结构是至关重要

主机的本地DNS服务器通常“邻近”本主机。当主机发出DNS请求时，该请求被发往本地DNS服器，它起着**代理**的作用，并将该请求转发
到DNS服务器层次结构中，详细的调用过程如下两种

**递归查询**

名字解析负担都放在当前联络的名字服务器上，解决方式： 迭代查询

![image-20240825143810226](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240825143810226.png) 

**迭代查询**

- 根（及各级域名）服务器返回的不是查询结果，而是下一个 DNS 的地址
- 最后由权威名字服务器给出解析结果

![image-20240825143430490](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240825143430490.png) 

##### DNS 缓存

为了改善时延性能并减少在因特网上到处传输的DNS报文数量，DNS广泛使用了缓存技术

- DNS缓存的原理非常简单。在一个请求链中，当某DNS服务器接收一个DNS回答（包含某主机名到 ip 地址的映射）时，它能将映射缓存在本地存储器中
- 由于主机和主机名与 ip 地址间的映射并不是永久的，DNS服务器在一段时间后（通常设置为两天）将丢弃缓存的信息

#### 记录和报文

##### 资源记录

- 作用：维护域名 - ip 地址(其它)的映射关系
- 位置：Name Server的分布式数据库中
- RR格式: （Domain_name，Ttl，Type，Class，Value）
  - Domain_name: 域名
  - Ttl: time to live : 生存时间，决定了资源记录应当从缓存中删除的时间
  - Class 类别 ：对于Internet，值为 IN
  - Value 值：可以是数字，域名或ASCII串
  - Type 类别：资源记录的类型

对于不同的 Type 类型，转换的方式不同，如下

- Type = A：Name 为主机；Value 为 ip 地址
- Type = CHAME：Name 为规范名字的别名；Value 为规范名字
- Type = NS：Name 为域名；Value 为该领域的权威服务器的域名
- Type = MX：Name 为邮件服务器的规范名字的别名；Value 为邮件服务器的规范名字

##### 报文

DNS 只有这两种报文，并且查询和回答报文有着相同的格式

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240826130110784.png" alt="image-20240826130110784" style="zoom:80%;" />  

- 前 12 个字节是首部区域。第一个字段(标识符)是一个 16 比特的数，用于标识该查询（类似于订单号的作用）
- 问题区域包含着正在进行的查询信息该区域包括：①名字字段 ②类型字段
- 回答区域包含了对最初请求的名字的资源记录
- 权威区域包含了其他权威服务器的记录

----

### P2P 应用

- 没有（或极少）一直运行的服务器
- 任意端系统都可以直接通信
- Peer 节点间歇上网，每次 ip 地址都有可能变化

**例子**

- 文件分发 (BitTorrent)
- 流媒体 (KanKan)
- VoIP (Skype) 

#### P2P 体系结构的扩展性

**分发时间**是所有对等方得到该文件的副本所需要的时间

如图所示，对于客户一服务器体系结构，随着对等方数量的增加，分发时间呈线性增长并且没有界。然而，对于P2P体系结构，最小分发时间不仅总是小于客户 - 服务器体系结构的分发时间，并且对于任意的对等方数量N，总是小于1小时（计算）

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240829201304498.png" alt=" " style="zoom:80%;" /> 

因此，具有P2P体系结构的应用程序能够是自扩展的。这种扩展性的直接成因是：**对等方除了是比特的消费者外还是它们的重新分发者**

#### BitTorrent 协议

BitTorrent是一种用于文件分发的流行P2P协议【Chao 2011】

##### torrenl 洪流

参与一个特定文件分发的所有对等方的集合

- 在一个洪流中的对等方彼此下载等长度的文件块 (chunk) ，典型的块长度为 256KB
- 当一个对等方首次加入一个洪流时，它没有块随着时间的流逝，它累积了越来越多的块 当它下载块时，也为其他对等方上载了多个块。一旦某对等方获得了整个文件，它也许(自私地)离开洪流，或(大公无私地)留在该洪流中并继续向其他对等方上载块
- 任何对等方可能在任何时候仅具有块的子集就离开该洪流，并在以后重新加入该洪流中

##### BitTorrent 运行的过程

**概述**

每个洪流具有一个基础设施节点，称为**追踪器**( tracker)

当一个对等方加入某洪流时，它向追踪器注册自己，并周期性地通知追踪器它仍在该洪流中，假设当一个新的对等方 Alice 加入该洪流时，追踪器随机地从参与对等方的集合中选择对等方的一个子集 ，并将这些对等方的 ip 地址发送给 Alice

<img src="https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240830191634898.png" alt="image-20240830191634898" style="zoom: 50%;" />  

**具体过程**

- 在任何给定的时间，每个对等方将具有来自该文件的块的子集，并且不同的对等方具有不同的子集（文件被分成 256KB 的块，每个对等放会用 bitmap 来记录每个块的状态，并相互询问每个邻近对等方它们所具有的块列表）
- 将使用**最稀缺优先技术**（最稀缺的块就是那些在她的邻居中副本数量中最少的块）来优先请求哪些块，这样，最稀缺块得到更为迅速的重新分发，其目标是(大致地)均衡每个块在洪流中的副本数量
- 为了决定她响应哪个请求， BitTorrent 使用了一种机灵的对换算法。根据当前能够以最高速率向她提供数据的邻居，确定以最高速率流人的 4 个邻居并给出其主优先权
- 每过 10秒将重新确认该 4 个邻居（这 4 个对等方被称为疏通），重要的是，每过 30 秒，她也要**随机**地选择另外一个邻居并向其发送块，如果发现该块最高速率优于之前选择的 4 个邻居，将会在下个周期替代 4 个邻居中速率最低得那一个（除这 5 个之外，其他块都必须进入到阻塞的状态）

#### P2P文件共享应用

**存在的问题**

- 如何定位所需资源
- 如何处理对等方的加入与离开

##### 非结构化 P2P

- 集中化目录
- 完全分布式
- 混合体

**集中化目录**

最初的 **Napster** 设计，当对等方连接时，它告知中心服务器： ip 地址、 内容

**存在的问题**：文件传输是分散的，而定位内容则是高度集中的

- 单点故障
- 性能瓶颈
- 侵犯版权

**查询洪泛：Gnutella**

- 全分布式，没有中心服务器
- 限制范围的洪泛查询（通常所连接的节点少于10个）
- 开放文件共享协议
- 许多 Gnutella 客户端实现了Gnutella协议（类似HTTP有许多的浏览器）

**利用不匀称性：KaZaA**

- 每个对等方要么是一个组长，要么隶属于一个组长
- 组长跟踪其所有的孩子的内容
- 组长与其他组长联系（转发查询到其他组长、获得其他组长的数据拷贝）

![image-20240902215526896](https://use-typora.oss-cn-hangzhou.aliyuncs.com/image-20240902215526896.png) 

**查询过程**

- 客户端向其组长发送关键字匹配描述的方式查询（每个文件有一个散列标识码和一个描述符）
- 组长用匹配进行响应，对每个匹配：元数据、散列标识码和 ip 地址
- 如果组长将查询转发给其他组长，其他组长也以匹配进行响应
- 客户端选择要下载的文件，向拥有文件的对等方发送一个带散列标识码的 HTTP 请求

##### DHT 结构化 P2P（了解）

树形、环形等